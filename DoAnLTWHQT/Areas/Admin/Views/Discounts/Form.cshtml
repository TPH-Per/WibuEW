@model Ltwhqt.ViewModels.Admin.DiscountFormViewModel
@{
    ViewBag.Title = ViewBag.Title ?? "Thông tin mã giảm giá";
    var isEdit = Model.Id.HasValue && Model.Id > 0;
}

<div class="card border-0 shadow-sm">
    <div class="card-header bg-transparent border-0 py-3">
        <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                <i class="bi bi-ticket-perforated text-primary fs-4"></i>
            </div>
            <div>
                <h5 class="mb-0 fw-bold">@ViewBag.Title</h5>
                <small class="text-muted">@(isEdit ? "Chỉnh sửa thông tin mã giảm giá" : "Tạo mã giảm giá mới")</small>
            </div>
        </div>
    </div>
    <div class="card-body">
        @using (Html.BeginForm("Save", "Discounts", FormMethod.Post, new { @class = "needs-validation", id = "discountForm" }))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(m => m.Id)

            if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    @Html.ValidationSummary(false)
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Section 1: Thông tin cơ bản -->
            <div class="mb-4">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-info-circle me-2"></i>Thông tin cơ bản
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Mã Code <span class="text-danger">*</span></label>
                        @if (isEdit)
                        {
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-upc"></i></span>
                                <input class="form-control bg-light" value="@Model.Code" readonly disabled />
                            </div>
                            @Html.HiddenFor(m => m.Code)
                            <small class="text-muted"><i class="bi bi-lock me-1"></i>Không thể sửa mã code sau khi tạo</small>
                        }
                        else
                        {
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-upc"></i></span>
                                @Html.TextBoxFor(m => m.Code, new { @class = "form-control text-uppercase", placeholder = "VD: GIAM50K", required = "required", maxlength = "20" })
                            </div>
                            <small class="text-muted">Mã code viết hoa, không dấu, không khoảng trắng</small>
                        }
                        @Html.ValidationMessageFor(m => m.Code, "", new { @class = "text-danger small" })
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-medium">Số lượt dùng tối đa</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-hash"></i></span>
                            @Html.TextBoxFor(m => m.MaxUses, new { @class = "form-control", type = "number", placeholder = "Không giới hạn", min = "0" })
                        </div>
                        <small class="text-muted">Để trống nếu không giới hạn số lượt sử dụng</small>
                    </div>
                </div>
            </div>

            <!-- Section 2: Giá trị giảm giá -->
            <div class="mb-4">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-currency-dollar me-2"></i>Giá trị giảm giá
                </h6>
                
                <!-- Info box -->
                

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Số tiền giảm (VNĐ) <span class="text-danger">*</span></label>
                        @if (isEdit)
                        {
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">₫</span>
                                <input class="form-control bg-light fs-4 fw-bold text-success" value="@(Model.Value.HasValue ? Model.Value.Value.ToString("N0") : "0")" readonly disabled />
                            </div>
                            @Html.HiddenFor(m => m.Value)
                            <small class="text-muted"><i class="bi bi-lock me-1"></i>Không thể sửa giá trị sau khi tạo</small>
                        }
                        else
                        {
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">₫</span>
                                @Html.TextBoxFor(m => m.Value, new { @class = "form-control fs-4", type = "number", placeholder = "50000", required = "required", min = "1000", step = "1000" })
                            </div>
                            <small class="text-muted">Nhập số tiền sẽ được trừ trực tiếp vào đơn hàng</small>
                        }
                        @Html.ValidationMessageFor(m => m.Value, "", new { @class = "text-danger small" })
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-medium">Đơn hàng tối thiểu (VNĐ)</label>
                        <div class="input-group">
                            <span class="input-group-text">₫</span>
                            @Html.TextBoxFor(m => m.MinOrderAmount, new { @class = "form-control", type = "number", placeholder = "Không yêu cầu", min = "0", step = "10000" })
                        </div>
                        <small class="text-muted">Mã chỉ áp dụng cho đơn từ giá trị này trở lên</small>
                    </div>
                </div>

                <!-- Quick value presets -->
                <div class="mt-3">
                    <label class="form-label fw-medium">Chọn nhanh giá trị:</label>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm value-preset" data-value="10000">10.000₫</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm value-preset" data-value="20000">20.000₫</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm value-preset" data-value="50000">50.000₫</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm value-preset" data-value="100000">100.000₫</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm value-preset" data-value="200000">200.000₫</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm value-preset" data-value="500000">500.000₫</button>
                    </div>
                </div>
            </div>

            <!-- Section 3: Thời gian áp dụng -->
            <div class="mb-4">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-calendar-range me-2"></i>Thời gian áp dụng
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Ngày bắt đầu</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-plus"></i></span>
                            <input type="datetime-local" class="form-control" name="StartAt" 
                                   value="@(Model.StartAt.HasValue ? Model.StartAt.Value.ToString("yyyy-MM-ddTHH:mm") : "")" />
                        </div>
                        <small class="text-muted">Để trống nếu có hiệu lực ngay</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-medium">Ngày kết thúc</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-x"></i></span>
                            <input type="datetime-local" class="form-control" name="EndAt" 
                                   value="@(Model.EndAt.HasValue ? Model.EndAt.Value.ToString("yyyy-MM-ddTHH:mm") : "")" />
                        </div>
                        <small class="text-muted">Để trống nếu không giới hạn thời gian</small>
                    </div>

                    <!-- Quick date presets -->
                    <div class="col-12">
                        <label class="form-label fw-medium">Chọn nhanh thời gian:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="radio" class="btn-check" name="datePreset" id="preset7days" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="preset7days">
                                <i class="bi bi-calendar-week me-1"></i>7 ngày
                            </label>

                            <input type="radio" class="btn-check" name="datePreset" id="preset30days" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="preset30days">
                                <i class="bi bi-calendar-month me-1"></i>30 ngày
                            </label>

                            <input type="radio" class="btn-check" name="datePreset" id="presetMonth" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="presetMonth">
                                <i class="bi bi-calendar me-1"></i>Hết tháng này
                            </label>

                            <input type="radio" class="btn-check" name="datePreset" id="presetNoLimit" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="presetNoLimit">
                                <i class="bi bi-infinity me-1"></i>Không giới hạn
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Trạng thái -->
            <div class="mb-4">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-toggles me-2"></i>Trạng thái
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card border-0" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                            <div class="card-body py-3">
                                <div class="form-check form-switch">
                                    @Html.CheckBoxFor(m => m.IsActive, new { @class = "form-check-input", id = "isActiveSwitch", role = "switch" })
                                    <label class="form-check-label fw-medium" for="isActiveSwitch">
                                        <i class="bi bi-check-circle text-success me-1"></i>
                                        Kích hoạt mã giảm giá
                                    </label>
                                </div>
                                <small class="text-muted">Mã chỉ sử dụng được khi được kích hoạt</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center">
                <a class="btn btn-light px-4" href="@Url.Action("Index")">
                    <i class="bi bi-arrow-left me-2"></i>Quay lại
                </a>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Đặt lại
                    </button>
                    <button class="btn btn-primary px-4" type="submit">
                        <i class="bi bi-check-lg me-2"></i>@(isEdit ? "Cập nhật" : "Tạo mã")
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@section scripts {
    <script>
        // Value presets
        document.querySelectorAll('.value-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const value = this.dataset.value;
                const valueInput = document.querySelector('input[name="Value"]');
                if (valueInput && !valueInput.disabled) {
                    valueInput.value = value;
                    // Highlight selected
                    document.querySelectorAll('.value-preset').forEach(b => b.classList.remove('btn-primary'));
                    document.querySelectorAll('.value-preset').forEach(b => b.classList.add('btn-outline-secondary'));
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-primary');
                }
            });
        });

        // Date presets
        document.getElementById('preset7days')?.addEventListener('change', function() {
            setDateRange(7);
        });
        document.getElementById('preset30days')?.addEventListener('change', function() {
            setDateRange(30);
        });
        document.getElementById('presetMonth')?.addEventListener('change', function() {
            const now = new Date();
            const start = new Date();
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59);
            document.querySelector('input[name="StartAt"]').value = formatDateTime(start);
            document.querySelector('input[name="EndAt"]').value = formatDateTime(end);
        });
        document.getElementById('presetNoLimit')?.addEventListener('change', function() {
            document.querySelector('input[name="StartAt"]').value = '';
            document.querySelector('input[name="EndAt"]').value = '';
        });

        function setDateRange(days) {
            const start = new Date();
            const end = new Date();
            end.setDate(end.getDate() + days);
            document.querySelector('input[name="StartAt"]').value = formatDateTime(start);
            document.querySelector('input[name="EndAt"]').value = formatDateTime(end);
        }

        function formatDateTime(date) {
            return date.toISOString().slice(0, 16);
        }

        function resetForm() {
            document.getElementById('discountForm').reset();
            document.querySelectorAll('.value-preset').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-secondary');
            });
        }

        // Auto uppercase code input
        document.querySelector('input[name="Code"]')?.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });
    </script>
}
