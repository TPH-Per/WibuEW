@model Ltwhqt.ViewModels.Admin.UserFormViewModel
@{
    ViewBag.Title = ViewBag.Title ?? "Thông tin tài khoản";
    var heading = Model.Id.HasValue ? "Cập nhật tài khoản" : "Tạo tài khoản mới";
    var actionUrl = Model.Id.HasValue 
        ? Url.Action("Edit", "Users", new { area = "Admin", id = Model.Id }) 
        : Url.Action("Create", "Users", new { area = "Admin" });
}

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <h2 class="h5 mb-4">@heading</h2>
        
        @if (ViewBag.ErrorMessage != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>@ViewBag.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        
        @if (ViewBag.SuccessMessage != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@ViewBag.SuccessMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        
        <form action="@actionUrl" method="post" id="userForm">
            @Html.AntiForgeryToken()
            
            @if (Model.Id.HasValue)
            {
                <input type="hidden" name="Id" value="@Model.Id" />
            }
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Username <span class="text-danger">*</span></label>
                    <input class="form-control" name="Name" value="@Model.Name" placeholder="perw.admin" required />
                    @Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger small" })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Tên hiển thị <span class="text-danger">*</span></label>
                    <input class="form-control" name="FullName" value="@Model.FullName" placeholder="Họ và tên" required />
                    @Html.ValidationMessageFor(m => m.FullName, "", new { @class = "text-danger small" })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email đăng nhập <span class="text-danger">*</span></label>
                    <input class="form-control" type="email" name="Email" value="@Model.Email" placeholder="admin@perw.vn" required />
                    @Html.ValidationMessageFor(m => m.Email, "", new { @class = "text-danger small" })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Số điện thoại</label>
                    <input class="form-control" name="PhoneNumber" value="@Model.PhoneNumber" placeholder="09xx xxx xxx" />
                </div>
                
                @if (!Model.Id.HasValue)
                {
                    <!-- Tạo mới: Mật khẩu bắt buộc -->
                    <div class="col-md-6">
                        <label class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                        <input class="form-control" type="password" name="Password" placeholder="Nhập mật khẩu" required minlength="6" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                        <input class="form-control" type="password" name="ConfirmPassword" placeholder="Nhập lại mật khẩu" required />
                    </div>
                }
                else
                {
                    <!-- Chỉnh sửa: Đổi mật khẩu (tùy chọn) -->
                    <div class="col-12">
                        <hr class="my-3" />
                        <h6 class="text-secondary mb-3">
                            <i class="bi bi-key me-2"></i>Đổi mật khẩu <small class="text-muted">(để trống nếu không đổi)</small>
                        </h6>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Mật khẩu mới</label>
                        <input class="form-control" type="password" name="Password" placeholder="Nhập mật khẩu mới" minlength="6" />
                        <small class="text-muted">Tối thiểu 6 ký tự. Để trống nếu không muốn đổi mật khẩu.</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Xác nhận mật khẩu mới</label>
                        <input class="form-control" type="password" name="ConfirmPassword" placeholder="Nhập lại mật khẩu mới" />
                    </div>
                }
                
                <div class="col-md-4">
                    <label class="form-label">Role <span class="text-danger">*</span></label>
                    <select class="form-select" name="Role" id="RoleSelect" required>
                        <option value="">-- Chọn role --</option>
                        @foreach (var role in Model.RoleOptions)
                        {
                            <option value="@role.Value" @(role.Value == Model.Role ? "selected" : "")>@role.Label</option>
                        }
                    </select>
                </div>
                <div class="col-md-4" id="BranchField" style="display: none;">
                    <label class="form-label">Chi nhánh quản lý</label>
                    <select class="form-select" name="BranchId" id="BranchSelect">
                        <option value="">-- Chọn chi nhánh (tùy chọn) --</option>
                        @foreach (var branch in Model.BranchOptions)
                        {
                            <option value="@branch.Value" @(branch.Value == Model.BranchId?.ToString() ? "selected" : "")>@branch.Label</option>
                        }
                    </select>
                    <small class="text-secondary">Chỉ hiển thị chi nhánh chưa có người quản lý</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" name="Status">
                        <option value="active" @(Model.Status == "active" ? "selected" : "")>Active</option>
                        <option value="inactive" @(Model.Status == "inactive" ? "selected" : "")>Inactive</option>
                    </select>
                </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a class="btn btn-light" href="@Url.Action("Index")">Huỷ</a>
                <button class="btn btn-primary" type="submit" id="submitBtn">
                    <i class="fas fa-save me-2"></i>Lưu thông tin
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var roleSelect = document.getElementById('RoleSelect');
        var branchField = document.getElementById('BranchField');
        var branchSelect = document.getElementById('BranchSelect');
        
        function toggleBranchField() {
            var selectedRole = roleSelect.value;
            if (selectedRole === 'branch_manager') {
                branchField.style.display = 'block';
            } else {
                branchField.style.display = 'none';
                branchSelect.value = '';
            }
        }
        
        roleSelect.addEventListener('change', toggleBranchField);
        toggleBranchField(); // Trigger on page load
    });

    document.getElementById('userForm').addEventListener('submit', function(e) {
        var password = document.querySelector('input[name="Password"]');
        var confirmPassword = document.querySelector('input[name="ConfirmPassword"]');
        
        // Chỉ validate khi có nhập password
        if (password && confirmPassword && password.value.length > 0) {
            if (password.value !== confirmPassword.value) {
                e.preventDefault();
                alert('Mật khẩu xác nhận không khớp!');
                return false;
            }
            if (password.value.length < 6) {
                e.preventDefault();
                alert('Mật khẩu phải có ít nhất 6 ký tự!');
                return false;
            }
        }
        
        // Disable button to prevent double submit
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
        
        return true;
    });
</script>

