@model IEnumerable<Ltwhqt.ViewModels.Admin.TotalInventoryReportViewModel>
@{
    ViewBag.Title = "Báo cáo tổng tồn kho";
    
    // Tính tổng
    var totalWarehouse = Model.Where(m => m.LoaiKho == "Kho Tổng").Sum(m => m.TongSoLuongTon);
    var totalBranch = Model.Where(m => m.LoaiKho == "Chi Nhánh").Sum(m => m.TongSoLuongTon);
    var totalReserved = Model.Sum(m => m.HangDatTruoc);
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Warning"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        @TempData["Warning"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@section Styles {
    <link href="@Url.Content("~/wwwroot/css/areas/admin-dashboard.css")" rel="stylesheet" />
    <style>
        .stat-card {
            border-radius: 12px;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 1rem;
        }
        .stat-card.warehouse {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .stat-card.branch {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }
        .stat-card.reserved {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .location-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .location-type.warehouse {
            background-color: #d4edda;
            color: #155724;
        }
        .location-type.branch {
            background-color: #fff3cd;
            color: #856404;
        }
        .inventory-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .inventory-table tbody tr:hover {
            background-color: #f1f3f5;
        }
        .quantity-badge {
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>
}

<div class="mb-4">
    <h2 class="h4 mb-1">
        <i class="bi bi-box-seam me-2"></i>Báo cáo Tổng Tồn Kho
    </h2>
    <p class="text-secondary mb-0">Tổng quan tồn kho trên toàn hệ thống (Kho tổng + Chi nhánh)</p>
</div>

<!-- Thống kê tổng quan -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="stat-card warehouse">
            <div class="stat-value">@totalWarehouse.ToString("N0")</div>
            <div class="stat-label">Tồn kho tổng</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card branch">
            <div class="stat-value">@totalBranch.ToString("N0")</div>
            <div class="stat-label">Tồn chi nhánh</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card reserved">
            <div class="stat-value">@totalReserved.ToString("N0")</div>
            <div class="stat-label">Đang giữ (Reserved)</div>
        </div>
    </div>
</div>

<!-- Bảng chi tiết -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>Chi tiết theo địa điểm
            </h5>
            <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>In báo cáo
            </button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table inventory-table align-middle mb-0">
            <thead>
                <tr>
                    <th style="width: 40%;">Tên Kho / Chi nhánh</th>
                    <th style="width: 15%;">Loại</th>
                    <th style="width: 15%;" class="text-end">Tổng tồn</th>
                    <th style="width: 15%;" class="text-end">Đang giữ</th>
                    <th style="width: 15%;" class="text-end">Khả dụng</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-5">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            Chưa có dữ liệu tồn kho
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model)
                    {
                        var typeClass = item.IsWarehouse ? "warehouse" : "branch";
                        var rowClass = item.TongSoLuongTon == 0 ? "table-light text-muted" : "";
                        
                        <tr class="@rowClass">
                            <td>
                                <strong>@item.TenKho</strong>
                            </td>
                            <td>
                                <span class="location-type @typeClass">@item.LoaiKho</span>
                            </td>
                            <td class="text-end">
                                <span class="quantity-badge text-primary">@item.TongSoLuongTon.ToString("N0")</span>
                            </td>
                            <td class="text-end">
                                @if (item.HangDatTruoc > 0)
                                {
                                    <span class="badge bg-warning text-dark">@item.HangDatTruoc.ToString("N0")</span>
                                }
                                else
                                {
                                    <span class="text-muted">0</span>
                                }
                            </td>
                            <td class="text-end">
                                <span class="quantity-badge @(item.SoLuongKhaDung > 0 ? "text-success" : "text-danger")">
                                    @item.SoLuongKhaDung.ToString("N0")
                                </span>
                            </td>
                        </tr>
                    }
                    
                    <!-- Tổng cộng -->
                    <tr class="table-dark">
                        <td><strong>TỔNG CỘNG</strong></td>
                        <td></td>
                        <td class="text-end"><strong>@((totalWarehouse + totalBranch).ToString("N0"))</strong></td>
                        <td class="text-end"><strong>@totalReserved.ToString("N0")</strong></td>
                        <td class="text-end"><strong>@((totalWarehouse + totalBranch - totalReserved).ToString("N0"))</strong></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Ghi chú -->
<div class="mt-4 p-3 bg-light rounded">
    <h6><i class="bi bi-info-circle me-2"></i>Ghi chú:</h6>
    <ul class="mb-0 small text-muted">
        <li><strong>Kho Tổng:</strong> Tồn kho tại các warehouse chính</li>
        <li><strong>Chi Nhánh:</strong> Tồn kho tại các branch (điểm bán)</li>
        <li><strong>Đang giữ (Reserved):</strong> Số lượng đã được đặt trước cho đơn hàng</li>
        <li><strong>Khả dụng:</strong> Số lượng có thể bán = Tổng tồn - Đang giữ</li>
    </ul>
</div>