@using DoAnLTWHQT
@model IEnumerable<purchase_orders>

@{
    ViewBag.Title = "Quản lý đơn hàng";
    // Lấy trạng thái hiện tại từ URL hoặc mặc định là 'all'
    var currentStatus = Request.QueryString["status"] ?? "all";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 mb-1 fw-bold">Đơn hàng toàn hệ thống</h2>
        <p class="text-secondary mb-0">Theo dõi và xử lý các đơn đặt hàng từ khách.</p>
    </div>

    @* Bộ lọc trạng thái *@
    <div class="d-flex gap-2">
        <form method="get" class="d-flex gap-2 align-items-center">
            <label class="fw-bold text-secondary small me-1">Trạng thái:</label>
            <select class="form-select form-select-sm shadow-sm" name="status" onchange="this.form.submit()" style="min-width: 150px;">
                <option value="all" @(currentStatus == "all" ? "selected" : "")>Tất cả đơn</option>
                <option value="pending" @(currentStatus == "pending" ? "selected" : "")>Chờ xử lý (Pending)</option>
                <option value="processing" @(currentStatus == "processing" ? "selected" : "")>Đang xử lý (Processing)</option>
                <option value="shipping" @(currentStatus == "shipping" ? "selected" : "")>Đang giao (Shipping)</option>
                <option value="completed" @(currentStatus == "completed" ? "selected" : "")>Hoàn thành (Completed)</option>
                <option value="cancelled" @(currentStatus == "cancelled" ? "selected" : "")>Đã hủy (Cancelled)</option>
            </select>
        </form>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-3">
    <div class="table-responsive">
        <table class="table align-middle mb-0 table-hover">
            <thead class="bg-light">
                <tr>
                    <th class="ps-3 py-3">Mã đơn</th>
                    <th class="py-3">Khách hàng</th>
                    <th class="py-3 text-center">Trạng thái</th>
                    <th class="py-3 text-end">Tổng tiền</th>
                    <th class="py-3">Ngày đặt</th>
                    <th class="text-end py-3 pe-3">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var order in Model)
                    {
                        <tr>
                            <td class="ps-3 fw-bold text-primary">
                                #@order.order_code
                            </td>

                            <td>
                                <div class="fw-medium">@(order.user != null ? order.user.full_name : order.shipping_recipient_name)</div>
                                <div class="small text-muted">@(order.user != null ? order.user.email : order.shipping_recipient_phone)</div>
                            </td>

                            <td class="text-center">
                                @{
                                    string badgeClass = "bg-secondary";
                                    string statusText = order.status;

                                    switch (order.status?.ToLower())
                                    {
                                        case "pending": badgeClass = "bg-warning text-dark"; break;
                                        case "processing": badgeClass = "bg-info text-dark"; break;
                                        case "shipping": badgeClass = "bg-primary"; break;
                                        case "completed": badgeClass = "bg-success"; break;
                                        case "cancelled": badgeClass = "bg-danger"; break;
                                    }
                                }
                                <span class="badge @badgeClass bg-opacity-75 rounded-pill px-3 py-2">
                                    @statusText
                                </span>
                            </td>

                            <td class="text-end fw-bold text-success">
                                @String.Format("{0:N0}", order.total_amount) ₫
                            </td>

                            <td>
                                <span class="d-block text-secondary">
                                    @(order.created_at.HasValue ? order.created_at.Value.ToString("dd/MM/yyyy") : "--")
                                </span>
                                <span class="small text-muted">
                                    @(order.created_at.HasValue ? order.created_at.Value.ToString("HH:mm") : "")
                                </span>
                            </td>

                            <td class="text-end pe-3">
                                <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Details", new { id = order.id })">
                                    Xem chi tiết <i class="bi bi-arrow-right ms-1"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-6 d-block mb-3 opacity-50"></i>
                            <p>Chưa có đơn hàng nào trong hệ thống.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>