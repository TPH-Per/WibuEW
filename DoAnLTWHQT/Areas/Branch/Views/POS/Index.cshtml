@{
    ViewBag.Title = "B√°n H√†ng T·∫°i Qu·∫ßy - " + ViewBag.BranchName;
}

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --danger-gradient: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .pos-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .pos-header {
        background: var(--primary-gradient);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        box-shadow: var(--card-shadow);
    }

    .pos-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .pos-header .branch-name {
        opacity: 0.9;
        font-size: 1.1rem;
        margin-top: 5px;
    }

    .search-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
    }

    .search-card:hover {
        box-shadow: var(--hover-shadow);
    }

    .search-input-wrapper {
        position: relative;
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 18px 55px 18px 25px;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 25px;
        top: 50%;
        transform: translateY(-50%);
        color: #667eea;
        font-size: 1.3rem;
    }

    .product-grid {
        display: grid;
        gap: 15px;
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .product-grid::-webkit-scrollbar {
        width: 8px;
    }

    .product-grid::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 10px;
    }

    .product-item {
        background: white;
        border: 2px solid #f0f0f0;
        border-radius: 15px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .product-item:hover:not(.disabled) {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
    }

    .product-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .product-icon {
        width: 60px;
        height: 60px;
        background: var(--primary-gradient);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.8rem;
        flex-shrink: 0;
    }

    .product-info {
        flex: 1;
    }

    .product-name {
        font-weight: 600;
        font-size: 1.05rem;
        margin-bottom: 5px;
        color: #2d3748;
    }

    .product-sku {
        font-size: 0.85rem;
        color: #718096;
    }

    .product-meta {
        text-align: right;
    }

    .product-price {
        font-size: 1.3rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
    }

    .stock-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .stock-badge.in-stock {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        color: white;
    }

    .stock-badge.out-of-stock {
        background: linear-gradient(135deg, #eb3349, #f45c43);
        color: white;
    }

    .cart-card {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        position: sticky;
        top: 20px;
        overflow: hidden;
    }

    .cart-header {
        background: var(--success-gradient);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cart-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .cart-count {
        background: rgba(255,255,255,0.3);
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
    }

    .cart-body {
        max-height: 400px;
        overflow-y: auto;
        padding: 0;
    }

    .cart-body::-webkit-scrollbar {
        width: 6px;
    }

    .cart-body::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        border-radius: 10px;
    }

    .cart-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: background 0.2s ease;
    }

    .cart-item:hover {
        background: #f8f9fa;
    }

    .cart-item-name {
        flex: 1;
        font-weight: 600;
        color: #2d3748;
        font-size: 0.95rem;
    }

    .qty-control {
        width: 80px;
    }

    .qty-input {
        width: 100%;
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        font-size: 1rem;
    }

    .qty-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .cart-item-price {
        font-weight: 700;
        color: #667eea;
        min-width: 100px;
        text-align: right;
    }

    .btn-remove {
        background: var(--danger-gradient);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-remove:hover {
        transform: scale(1.1) rotate(90deg);
    }

    .cart-empty {
        text-align: center;
        padding: 60px 20px;
        color: #a0aec0;
    }

    .cart-empty i {
        font-size: 4rem;
        margin-bottom: 15px;
        opacity: 0.3;
    }

    .cart-footer {
        background: #f8f9fa;
        padding: 20px;
    }

    .total-section {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 15px;
    }

    .total-label {
       font-size: 1.1rem;
        color: #718096;
        margin-bottom: 10px;
    }

    .total-amount {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .payment-select {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 1rem;
        margin-bottom: 15px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .payment-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 10px;
    }

    .btn-cancel {
        padding: 15px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: #718096;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #f8f9fa;
        border-color: #cbd5e0;
    }

    .btn-checkout {
        padding: 15px;
        border: none;
        background: var(--success-gradient);
        color: white;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
    }

    .btn-checkout:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
    }

    .btn-checkout:active {
        transform: translateY(0);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #a0aec0;
    }

    .empty-state i {
        font-size: 5rem;
        margin-bottom: 20px;
        opacity: 0.2;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .product-item {
        animation: slideIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .cart-item {
        animation: fadeIn 0.3s ease;
    }
</style>

<div class="pos-container">
    <div class="pos-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1><i class="bi bi-cash-coin me-3"></i>B√°n H√†ng T·∫°i Qu·∫ßy</h1>
                <div class="branch-name"><i class="bi bi-shop me-2"></i>@ViewBag.BranchName</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.9rem; opacity: 0.8;">Ng√†y:</div>
                <div style="font-size: 1.2rem; font-weight: 600;" id="currentDate"></div>
                <div style="font-size: 1rem; opacity: 0.9;" id="currentTime"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left: Product Search -->
        <div class="col-lg-7">
            <div class="search-card">
                <div class="search-input-wrapper">
                    <input type="text" 
                           id="productSearch" 
                           class="search-input" 
                           placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m theo t√™n, SKU..." 
                           autocomplete="off" 
                           autofocus>
                    <i class="bi bi-search search-icon"></i>
                </div>

                <div class="product-grid" id="searchResults">
                    <div class="empty-state">
                        <i class="bi bi-upc-scan"></i>
                        <p style="font-size: 1.1rem; margin: 0;">Nh·∫≠p t√™n ho·∫∑c SKU ƒë·ªÉ t√¨m ki·∫øm s·∫£n ph·∫©m</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Cart -->
        <div class="col-lg-5">
            <div class="cart-card">
                <div class="cart-header">
                    <h3><i class="bi bi-cart4 me-2"></i>Gi·ªè H√†ng</h3>
                    <span class="cart-count" id="cartCount">0 SP</span>
                </div>

                <div class="cart-body" id="cartTableBody">
                    <div class="cart-empty">
                        <i class="bi bi-cart-x"></i>
                        <p>Gi·ªè h√†ng tr·ªëng</p>
                        <small>Th√™m s·∫£n ph·∫©m ƒë·ªÉ b·∫Øt ƒë·∫ßu</small>
                    </div>
                </div>

                <div class="cart-footer">
                    <div class="total-section">
                        <!-- Voucher Input -->
                        <div class="voucher-section mb-3">
                            <label class="form-label text-muted small mb-1">M√£ gi·∫£m gi√° (Voucher)</label>
                            <div class="input-group">
                                <input type="text" id="voucherCode" class="form-control" placeholder="Nh·∫≠p m√£ voucher..." style="border-radius: 10px 0 0 10px;">
                                <button class="btn btn-outline-primary" type="button" id="btnApplyVoucher" style="border-radius: 0 10px 10px 0;">
                                    <i class="bi bi-ticket-perforated me-1"></i> √Åp d·ª•ng
                                </button>
                            </div>
                            <div id="voucherInfo" class="mt-2" style="display: none;">
                                <div class="alert alert-success py-2 mb-0" style="border-radius: 10px;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="bi bi-check-circle me-1"></i>
                                            <span id="voucherName">M√£ ABC</span>: Gi·∫£m <strong id="voucherValue">0‚Ç´</strong>
                                        </span>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="btnRemoveVoucher">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="voucherError" class="text-danger small mt-1" style="display: none;"></div>
                        </div>

                        <!-- Subtotal -->
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">T·∫°m t√≠nh:</span>
                            <span id="subTotalAmount">0‚Ç´</span>
                        </div>
                        
                        <!-- Discount -->
                        <div class="d-flex justify-content-between mb-2" id="discountRow" style="display: none !important;">
                            <span class="text-success">Gi·∫£m gi√°:</span>
                            <span class="text-success" id="discountAmount">-0‚Ç´</span>
                        </div>

                        <hr class="my-2">
                        
                        <!-- Total -->
                        <div class="total-label">T·ªïng Ti·ªÅn:</div>
                        <div class="total-amount" id="totalAmount">0‚Ç´</div>
                    </div>

                    <select id="paymentMethod" class="payment-select">
                        <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n --</option>
                        @foreach (var pm in ViewBag.PaymentMethods as SelectList)
                        {
                            <option value="@pm.Value">üí≥ @pm.Text</option>
                        }
                    </select>

                    <div class="action-buttons">
                        <button id="btnCancel" class="btn-cancel">
                            <i class="bi bi-x-circle me-1"></i> H·ªßy
                        </button>
                        <button id="btnCheckout" class="btn-checkout">
                            <i class="bi bi-check-circle me-2"></i> THANH TO√ÅN
                        </button>
                    </div>
                </div>
            </div>
        </div>
</div>

<!-- Hidden Fields -->
<input type="hidden" id="currentBranchId" value="@ViewBag.CurrentBranchID" />
<input type="hidden" id="currentUserId" value="@ViewBag.CurrentUserID" />

<!-- QR Code Payment Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <h5 class="modal-title text-white" id="qrCodeModalLabel">
                    <i class="bi bi-qr-code me-2"></i>Thanh To√°n QR Code
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="text-muted mb-3">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; display: inline-block;">
                    <img src="@Url.Content("~/Content/qr.jpg")" alt="QR Code" style="max-width: 250px; border-radius: 10px;" />
                </div>
                <div class="mt-3">
                    <div class="fw-bold fs-4 text-primary" id="qrTotalAmount">0‚Ç´</div>
                    <small class="text-muted">S·ªë ti·ªÅn c·∫ßn thanh to√°n</small>
                </div>
                <div class="alert alert-info mt-3" style="border-radius: 10px;">
                    <i class="bi bi-info-circle me-2"></i>
                    Sau khi chuy·ªÉn kho·∫£n th√†nh c√¥ng, nh·∫•n <strong>"X√°c nh·∫≠n ƒë√£ thanh to√°n"</strong>
                </div>
            </div>
            <div class="modal-footer" style="border: none; padding: 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">
                    <i class="bi bi-x-circle me-1"></i> H·ªßy
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmQR" style="border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none;">
                    <i class="bi bi-check-circle me-2"></i> X√°c nh·∫≠n ƒë√£ thanh to√°n
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    console.log('POS Premium Script loaded');
    
    $(document).ready(function () {
        var cart = [];
        var typingTimer;

        // Update clock
        function updateClock() {
            const now = new Date();
            $('#currentDate').text(now.toLocaleDateString('vi-VN'));
            $('#currentTime').text(now.toLocaleTimeString('vi-VN'));
        }
        updateClock();
        setInterval(updateClock, 1000);
        
        // Format currency
        function formatVND(n) {
            return n.toLocaleString('vi-VN') + '‚Ç´';
        }

        // Search Products
        $('#productSearch').on('input', function () {
            var query = $(this).val();
            clearTimeout(typingTimer);
            
            if (query.length < 2) {
                // Show preloaded inventory products if available
                if (window.inventoryProducts && window.inventoryProducts.length > 0) {
                    renderProducts(window.inventoryProducts);
                } else {
                    $('#searchResults').html(
                        '<div class="empty-state">' +
                        '<i class="bi bi-upc-scan"></i>' +
                        '<p style="font-size: 1.1rem; margin: 0;">Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm</p>' +
                        '</div>'
                    );
                }
                return;
            }

            typingTimer = setTimeout(function () {
                $.get('/Branch/POS/SearchProducts', { query: query }, function (data) {
                    renderProducts(data);
                });
            }, 300);
        });

        // Helper function to render products
        function renderProducts(data) {
            // Ensure data is an array
            if (!Array.isArray(data)) {
                data = [];
            }
            
            var html = '';
            if(data.length === 0) {
                html = '<div class="empty-state">' +
                       '<i class="bi bi-inbox"></i>' +
                       '<p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ s·∫£n ph·∫©m trong kho</p>' +
                       '</div>';
            } else {
                for (var i = 0; i < data.length; i++) {
                    var p = data[i];
                    var stockBadge = p.stock > 0 
                        ? '<span class="stock-badge in-stock">C√≤n: ' + p.stock + '</span>' 
                        : '<span class="stock-badge out-of-stock">H·∫øt h√†ng</span>';
                    
                    var disabled = p.stock <= 0 ? 'disabled' : '';
                    
                    html += '<div class="product-item ' + disabled + '" ' +
                            'data-id="' + p.id + '" ' +
                            'data-name="' + p.name + '" ' +
                            'data-price="' + p.price + '" ' +
                            'data-stock="' + p.stock + '">' +
                            '<div class="product-icon"><i class="bi bi-box-seam"></i></div>' +
                            '<div class="product-info">' +
                            '<div class="product-name">' + p.name + '</div>' +
                            '<div class="product-sku">SKU: ' + p.sku + '</div>' +
                            '</div>' +
                            '<div class="product-meta">' +
                            '<div class="product-price">' + formatVND(p.price) + '</div>' +
                            stockBadge +
                            '</div>' +
                            '</div>';
                }
            }
            $('#searchResults').html(html);
        }

        // Auto-load products from branch inventory on page load
        window.inventoryProducts = [];
        console.log('Starting to load inventory products...');
        
        $.ajax({
            url: '/Branch/POS/GetBranchInventoryProducts',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                console.log('API Response:', response);
                console.log('Response type:', typeof response);
                console.log('Is array:', Array.isArray(response));
                
                if (Array.isArray(response) && response.length > 0) {
                    window.inventoryProducts = response;
                    renderProducts(response);
                    console.log('SUCCESS: Loaded ' + response.length + ' products');
                } else {
                    console.log('No products returned or not an array');
                    $('#searchResults').html(
                        '<div class="empty-state">' +
                        '<i class="bi bi-inbox"></i>' +
                        '<p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ s·∫£n ph·∫©m trong kho</p>' +
                        '</div>'
                    );
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', status, error);
                console.error('Response Text:', xhr.responseText);
                $('#searchResults').html(
                    '<div class="empty-state">' +
                    '<i class="bi bi-exclamation-triangle text-danger"></i>' +
                    '<p style="font-size: 1.1rem; margin: 0;">L·ªói t·∫£i s·∫£n ph·∫©m</p>' +
                    '<small class="text-muted">' + error + '</small>' +
                    '</div>'
                );
            }
        });


        // Add to Cart
        $(document).on('click', '.product-item:not(.disabled)', function () {
            var id = $(this).data('id');
            var name = $(this).data('name');
            var price = $(this).data('price');
            var stock = $(this).data('stock');

            var existing = cart.find(x => x.VariantID == id);
            if (existing) {
                if (existing.Qty >= stock) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Kh√¥ng ƒë·ªß h√†ng!',
                        text: 'Ch·ªâ c√≤n ' + stock + ' s·∫£n ph·∫©m trong kho',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
                existing.Qty++;
            } else {
                cart.push({ 
                    VariantID: id, 
                    Name: name, 
                    Price: price, 
                    Qty: 1,
                    Stock: stock
                });
            }
            
            renderCart();
            $('#productSearch').val('').focus();
            
            // Success feedback
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'ƒê√£ th√™m v√†o gi·ªè!',
                showConfirmButton: false,
                timer: 1500
            });
        });

        // Remove from Cart
        $(document).on('click', '.btn-remove', function () {
            var id = $(this).data('id');
            cart = cart.filter(x => x.VariantID != id);
            renderCart();
        });

        // Change Qty
        $(document).on('change', '.qty-input', function() {
            var id = $(this).data('id');
            var val = parseInt($(this).val());
            
            var item = cart.find(x => x.VariantID == id);
            if(item) {
                if(val < 1) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu l√† 1',
                        confirmButtonColor: '#667eea'
                    });
                    $(this).val(1);
                    return;
                }
                
                if(val > item.Stock) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Kh√¥ng ƒë·ªß h√†ng!',
                        text: 'Ch·ªâ c√≤n ' + item.Stock + ' s·∫£n ph·∫©m trong kho',
                        confirmButtonColor: '#667eea'
                    });
                    $(this).val(item.Qty);
                    return;
                }
                
                item.Qty = val;
                renderCart();
            }
        });

        function renderCart() {
            var html = '';
            var total = 0;
            var count = 0;

            if (cart.length === 0) {
                html = '<div class="cart-empty">' +
                       '<i class="bi bi-cart-x"></i>' +
                       '<p>Gi·ªè h√†ng tr·ªëng</p>' +
                       '<small>Th√™m s·∫£n ph·∫©m ƒë·ªÉ b·∫Øt ƒë·∫ßu</small>' +
                       '</div>';
            } else {
                cart.forEach(function (item) {
                    var subtotal = item.Qty * item.Price;
                    total += subtotal;
                    count += item.Qty;
                   
                    html += '<div class="cart-item">' +
                            '<div class="cart-item-name">' + item.Name + '</div>' +
                            '<div class="qty-control">' +
                            '<input type="number" class="qty-input" ' +
                            'value="' + item.Qty + '" data-id="' + item.VariantID + '" ' +
                            'min="1" max="' + item.Stock + '">' +
                            '</div>' +
                            '<div class="cart-item-price">' + formatVND(subtotal) + '</div>' +
                            '<button class="btn-remove" data-id="' + item.VariantID + '">' +
                            '<i class="bi bi-x-lg"></i>' +
                            '</button>' +
                            '</div>';
                });
            }

            $('#cartTableBody').html(html);
            $('#subTotalAmount').text(formatVND(total));
            
            // Apply voucher discount
            var finalTotal = total;
            if (appliedVoucher) {
                var discountAmt = appliedVoucher.value;
                if (discountAmt > total) discountAmt = total; // Can't discount more than total
                finalTotal = total - discountAmt;
                $('#discountRow').show().css('display', 'flex');
                $('#discountAmount').text('-' + formatVND(discountAmt));
            } else {
                $('#discountRow').hide();
            }
            
            $('#totalAmount').text(formatVND(finalTotal));
            $('#cartCount').text(count + ' SP');
        }

        // Voucher handling
        var appliedVoucher = null;

        $('#btnApplyVoucher').click(function() {
            var code = $('#voucherCode').val().trim().toUpperCase();
            if (!code) {
                $('#voucherError').text('Vui l√≤ng nh·∫≠p m√£ voucher').show();
                return;
            }
            
            // Call API to validate voucher
            $.get('/Branch/POS/ValidateVoucher', { code: code }, function(res) {
                if (res.success) {
                    appliedVoucher = res.voucher;
                    $('#voucherName').text(res.voucher.code);
                    $('#voucherValue').text(formatVND(res.voucher.value));
                    $('#voucherInfo').show();
                    $('#voucherError').hide();
                    $('#voucherCode').prop('disabled', true);
                    $('#btnApplyVoucher').prop('disabled', true);
                    renderCart(); // Re-calculate totals
                    
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: '√Åp d·ª•ng voucher th√†nh c√¥ng!',
                        showConfirmButton: false,
                        timer: 2000
                    });
                } else {
                    $('#voucherError').text(res.message).show();
                    $('#voucherInfo').hide();
                }
            }).fail(function() {
                $('#voucherError').text('L·ªói k·∫øt n·ªëi server').show();
            });
        });

        $('#btnRemoveVoucher').click(function() {
            appliedVoucher = null;
            $('#voucherCode').val('').prop('disabled', false);
            $('#btnApplyVoucher').prop('disabled', false);
            $('#voucherInfo').hide();
            $('#voucherError').hide();
            renderCart();
        });

        // Checkout
        $('#btnCheckout').click(function () {
            if (cart.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Gi·ªè h√†ng tr·ªëng!',
                    text: 'Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n',
                    confirmButtonColor: '#667eea'
                });
                return;
            }

            if(!$('#paymentMethod').val()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Ch∆∞a ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!',
                    confirmButtonColor: '#667eea'
                });
                return;
            }

            var selectedPaymentText = $('#paymentMethod option:selected').text().toLowerCase();
            
            // Check if QR code payment (contains 'qr' or 'chuy·ªÉn kho·∫£n' or 'banking')
            var isQRPayment = selectedPaymentText.includes('qr') || selectedPaymentText.includes('chuy·ªÉn kho·∫£n') || selectedPaymentText.includes('banking') || selectedPaymentText.includes('bank');
            
            if (isQRPayment) {
                // Show QR Code Modal
                $('#qrTotalAmount').text($('#totalAmount').text());
                var qrModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
                qrModal.show();
            } else {
                // Direct payment confirmation (cash)
                confirmAndCheckout('cash_atBranch');
            }
        });

        // Confirm QR Payment
        $('#btnConfirmQR').click(function() {
            var qrModal = bootstrap.Modal.getInstance(document.getElementById('qrCodeModal'));
            qrModal.hide();
            processCheckout('qr_atBranch');
        });

        function confirmAndCheckout(paymentType) {
            Swal.fire({
                title: 'X√°c nh·∫≠n thanh to√°n?',
                html: 'T·ªïng ti·ªÅn: <strong style="color: #667eea; font-size: 1.5rem;">' + $('#totalAmount').text() + '</strong>',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-check-circle me-2"></i>Thanh To√°n',
                cancelButtonText: '<i class="bi bi-x-circle me-2"></i>H·ªßy',
                confirmButtonColor: '#11998e',
                cancelButtonColor: '#eb3349'
            }).then((result) => {
                if (result.isConfirmed) {
                    processCheckout(paymentType);
                }
            });
        }

        function processCheckout(paymentType) {
            var data = {
                branchId: $('#currentBranchId').val(),
                userId: $('#currentUserId').val(),
                paymentMethodId: $('#paymentMethod').val(),
                paymentType: paymentType, // 'qr_atBranch' or 'cash_atBranch'
                discountId: appliedVoucher ? appliedVoucher.id : null, // Voucher ID
                discountAmount: appliedVoucher ? appliedVoucher.value : 0, // Discount amount
                cartItems: cart.map(function(i) { 
                    return { VariantID: i.VariantID, Qty: i.Qty }; 
                })
            };

            $.ajax({
                url: '/Branch/POS/Checkout',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (res) {
                    // N·∫øu c√≥ success=true HO·∫∂C kh√¥ng c√≥ message l·ªói -> th√†nh c√¥ng
                    if ((res && res.success) || !res || !res.message) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thanh to√°n th√†nh c√¥ng!',
                            text: res && res.message ? res.message : 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o!',
                            confirmButtonColor: '#11998e'
                        });
                        cart = [];
                        appliedVoucher = null; // Reset voucher
                        $('#voucherCode').val('').prop('disabled', false);
                        $('#btnApplyVoucher').prop('disabled', false);
                        $('#voucherInfo').hide();
                        renderCart();
                        $('#productSearch').val('').focus();
                        $('#paymentMethod').val('');
                        // Reload products ƒë·ªÉ c·∫≠p nh·∫≠t t·ªìn kho
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: res.message,
                            confirmButtonColor: '#eb3349'
                        });
                    }
                },
                error: function (xhr) {
                    console.error(xhr);
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói k·∫øt n·ªëi!',
                        text: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server',
                        confirmButtonColor: '#eb3349'
                    });
                }
            });
        }

        $('#btnCancel').click(function() {
            if(cart.length > 0) {
                Swal.fire({
                    title: 'H·ªßy giao d·ªãch?',
                    text: 'T·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè s·∫Ω b·ªã x√≥a',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ƒê·ªìng √Ω',
                    cancelButtonText: 'Kh√¥ng',
                    confirmButtonColor: '#eb3349',
                    cancelButtonColor: '#667eea'
                }).then((result) => {
                    if (result.isConfirmed) {
                        cart = [];
                        renderCart();
                        $('#productSearch').val('').focus();
                    }
                });
            }
        });
    });
</script>
}
