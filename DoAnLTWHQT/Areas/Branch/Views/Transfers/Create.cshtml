@{
    ViewBag.Title = "Tạo Yêu Cầu Nhập Hàng";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fa fa-file-text"></i> Tạo Yêu Cầu Nhập Hàng Từ Kho</h4>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger">@TempData["Error"]</div>
                    }

                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> 
                        <strong>Lưu ý:</strong> Yêu cầu sẽ ở trạng thái <span class="badge badge-warning">Chờ duyệt</span> 
                        cho đến khi được Kho xác nhận.
                    </div>
                    
                    <form id="transferForm" method="post" action="@Url.Action("Create")">
                        @Html.AntiForgeryToken()
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Kho Nguồn</label>
                                    <input type="text" class="form-control" value="Kho tổng" readonly />
                                    <input type="hidden" id="warehouseId" name="warehouseId" value="1" />
                                    <small class="text-muted">Mặc định từ Kho tổng</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Chi Nhánh Nhận</label>
                                    <input type="text" class="form-control" value="@ViewBag.BranchName" readonly />
                                    <input type="hidden" id="branchId" name="branchId" value="@ViewBag.BranchId" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">Ghi Chú</label>
                            <textarea id="notes" name="notes" class="form-control" rows="2" placeholder="Nhập lý do yêu cầu nhập hàng..."></textarea>
                        </div>

                        <hr />

                        <h5 class="mb-3">Chi Tiết Sản Phẩm Yêu Cầu</h5>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered" id="productTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="45%">Sản Phẩm</th>
                                        <th width="15%">Số Lượng <span class="text-danger">*</span></th>
                                        <th width="30%">Ghi Chú</th>
                                        <th width="10%"></th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <!-- Dynamic rows -->
                                </tbody>
                            </table>
                        </div>

                        <button type="button" class="btn btn-secondary" id="addProductBtn">
                            <i class="fa fa-plus"></i> Thêm Sản Phẩm
                        </button>

                        <input type="hidden" id="detailsJson" name="detailsJson" />

                        <hr />

                        <div class="text-right">
                            <a href="@Url.Action("Index")" class="btn btn-secondary">
                                <i class="fa fa-times"></i> Hủy
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fa fa-paper-plane"></i> Gửi Yêu Cầu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function () {
        var detailsArray = [];
        var rowIndex = 0;

        // Add product row
        $('#addProductBtn').click(function () {
            rowIndex++;
            var row = `
                <tr data-row-index="${rowIndex}">
                    <td>
                        <select class="form-control product-select" data-row-index="${rowIndex}" required>
                            <option value="">-- Chọn sản phẩm --</option>
                            @foreach (var item in (List<SelectListItem>)ViewBag.ProductVariants)
                            {
                                <text><option value="@item.Value">@item.Text</option></text>
                            }
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control quantity-input" data-row-index="${rowIndex}" min="1" required placeholder="SL" />
                    </td>
                    <td>
                        <input type="text" class="form-control notes-input" data-row-index="${rowIndex}" placeholder="Ghi chú..." />
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger remove-row" data-row-index="${rowIndex}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            $('#productTableBody').append(row);
        });

        // Remove row
        $(document).on('click', '.remove-row', function () {
            var index = $(this).data('row-index');
            $(`tr[data-row-index="${index}"]`).remove();
        });

        // Submit form
        $('#transferForm').submit(function (e) {
            e.preventDefault();

            // Collect data
            detailsArray = [];
            $('#productTableBody tr').each(function () {
                var rowIndex = $(this).data('row-index');
                var variantId = $(`.product-select[data-row-index="${rowIndex}"]`).val();
                var quantity = $(`.quantity-input[data-row-index="${rowIndex}"]`).val();
                var notes = $(`.notes-input[data-row-index="${rowIndex}"]`).val();

                if (variantId && quantity) {
                    detailsArray.push({
                        ProductVariantId: parseInt(variantId),
                        Quantity: parseInt(quantity),
                        Notes: notes
                    });
                }
            });

            if (detailsArray.length === 0) {
                ModalPopup.warning('Thiếu sản phẩm!', 'Vui lòng thêm ít nhất một sản phẩm!');
                return false;
            }

            // Set JSON
            $('#detailsJson').val(JSON.stringify(detailsArray));

            // Submit
            this.submit();
        });

        // Auto add first row
        $('#addProductBtn').click();
    });
</script>
}
