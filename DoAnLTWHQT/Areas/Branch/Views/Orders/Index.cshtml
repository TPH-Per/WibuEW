@using DoAnLTWHQT
@model IEnumerable<purchase_orders>

@{
    ViewBag.Title = "Quản lý đơn hàng";
    var currentStatus = Request.QueryString["status"] ?? "all";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 mb-1 fw-bold">
            <i class="bi bi-bag-check me-2 text-primary"></i>Đơn hàng chi nhánh
        </h2>
        <p class="text-secondary mb-0">Quản lý và xử lý đơn hàng của chi nhánh bạn.</p>
    </div>

    @* Bộ lọc trạng thái *@
    <div class="d-flex gap-2">
        <form method="get" class="d-flex gap-2 align-items-center">
            <label class="fw-bold text-secondary small me-1">Trạng thái:</label>
            <select class="form-select form-select-sm shadow-sm" name="status" onchange="this.form.submit()" style="min-width: 160px;">
                <option value="all" @(currentStatus == "all" ? "selected" : "")>Tất cả đơn</option>
                <option value="pending" @(currentStatus == "pending" ? "selected" : "")>Chờ xử lý (Pending)</option>
                <option value="processing" @(currentStatus == "processing" ? "selected" : "")>Đang xử lý (Processing)</option>
                <option value="shipping" @(currentStatus == "shipping" ? "selected" : "")>Đang giao (Shipping)</option>
                <option value="completed" @(currentStatus == "completed" ? "selected" : "")>Hoàn thành (Completed)</option>
                <option value="cancelled" @(currentStatus == "cancelled" ? "selected" : "")>Đã hủy (Cancelled)</option>
            </select>
        </form>
    </div>
</div>

@* Thống kê nhanh *@
<div class="row g-3 mb-4">
    <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm bg-gradient" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
            <div class="card-body py-3 text-center">
                <div class="fs-3 fw-bold text-dark">@Model.Count()</div>
                <div class="small text-secondary">Tổng đơn</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fff3cd, #ffeeba);">
            <div class="card-body py-3 text-center">
                <div class="fs-3 fw-bold text-warning">@Model.Count(o => o.status == "pending")</div>
                <div class="small text-dark">Chờ xử lý</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #cff4fc, #9eeaf9);">
            <div class="card-body py-3 text-center">
                <div class="fs-3 fw-bold text-info">@Model.Count(o => o.status == "processing")</div>
                <div class="small text-dark">Đang xử lý</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #cfe2ff, #9ec5fe);">
            <div class="card-body py-3 text-center">
                <div class="fs-3 fw-bold text-primary">@Model.Count(o => o.status == "shipping")</div>
                <div class="small text-dark">Đang giao</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #d1e7dd, #a3cfbb);">
            <div class="card-body py-3 text-center">
                <div class="fs-3 fw-bold text-success">@Model.Count(o => o.status == "completed")</div>
                <div class="small text-dark">Hoàn thành</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f8d7da, #f5c2c7);">
            <div class="card-body py-3 text-center">
                <div class="fs-3 fw-bold text-danger">@Model.Count(o => o.status == "cancelled")</div>
                <div class="small text-dark">Đã hủy</div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-3">
    <div class="table-responsive">
        <table class="table align-middle mb-0 table-hover">
            <thead class="bg-light">
                <tr>
                    <th class="ps-3 py-3">Mã đơn</th>
                    <th class="py-3">Kênh</th>
                    <th class="py-3">Khách hàng</th>
                    <th class="py-3 text-center">Trạng thái</th>
                    <th class="py-3 text-end">Tổng tiền</th>
                    <th class="py-3">Ngày đặt</th>
                    <th class="text-end py-3 pe-3">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var order in Model)
                    {
                        <tr>
                            <td class="ps-3">
                                <span class="fw-bold text-primary">#@order.order_code</span>
                            </td>

                            @* Cột Kênh bán *@
                            <td>
                                @{
                                    // Phân biệt đơn Ecommerce vs POS:
                                    // - Ecommerce: có user_id và shipping_address đầy đủ
                                    // - POS: không có user_id hoặc shipping address
                                    bool isEcommerce = order.user_id.HasValue && !string.IsNullOrEmpty(order.shipping_address);
                                }
                                @if (isEcommerce)
                                {
                                    <span class="badge bg-purple-subtle text-purple border border-purple-subtle" style="background-color: rgba(111, 66, 193, 0.15); color: #6f42c1;">
                                        <i class="bi bi-globe me-1"></i>Website
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-teal-subtle text-teal border" style="background-color: rgba(32, 201, 151, 0.15); color: #198754;">
                                        <i class="bi bi-shop me-1"></i>Tại quầy
                                    </span>
                                }
                            </td>

                            <td>
                                <div class="fw-medium">@(order.user != null ? order.user.full_name : order.shipping_recipient_name)</div>
                                <div class="small text-muted">
                                    <i class="bi bi-telephone me-1"></i>@(order.shipping_recipient_phone ?? (order.user?.phone_number ?? "--"))
                                </div>
                            </td>

                            <td class="text-center">
                                @{
                                    string badgeClass = "bg-secondary";
                                    string statusText = order.status ?? "N/A";
                                    string statusIcon = "bi-question-circle";

                                    switch (order.status?.ToLower())
                                    {
                                        case "pending":
                                            badgeClass = "bg-warning text-dark";
                                            statusIcon = "bi-clock";
                                            statusText = "Chờ xác nhận";
                                            break;
                                        case "processing":
                                            badgeClass = "bg-info text-dark";
                                            statusIcon = "bi-gear";
                                            statusText = "Đang xử lý";
                                            break;
                                        case "shipping":
                                            badgeClass = "bg-primary";
                                            statusIcon = "bi-truck";
                                            statusText = "Đang giao";
                                            break;
                                        case "completed":
                                            badgeClass = "bg-success";
                                            statusIcon = "bi-check-circle";
                                            statusText = "Hoàn thành";
                                            break;
                                        case "cancelled":
                                            badgeClass = "bg-danger";
                                            statusIcon = "bi-x-circle";
                                            statusText = "Đã hủy";
                                            break;
                                    }
                                }
                                <span class="badge @badgeClass bg-opacity-85 rounded-pill px-3 py-2">
                                    <i class="bi @statusIcon me-1"></i>@statusText
                                </span>
                            </td>

                            <td class="text-end">
                                <span class="fw-bold text-success">@String.Format("{0:N0}", order.total_amount) ₫</span>
                            </td>

                            <td>
                                <span class="d-block text-secondary">
                                    @(order.created_at.HasValue ? order.created_at.Value.ToString("dd/MM/yyyy") : "--")
                                </span>
                                <span class="small text-muted">
                                    <i class="bi bi-clock me-1"></i>@(order.created_at.HasValue ? order.created_at.Value.ToString("HH:mm") : "")
                                </span>
                            </td>

                            <td class="text-end pe-3">
                                <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Details", new { id = order.id })">
                                    <i class="bi bi-eye me-1"></i>Xem
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-4 d-block mb-3 opacity-50"></i>
                            <p class="h5 mb-1">Chưa có đơn hàng nào</p>
                            <p class="text-muted small">Đơn hàng của chi nhánh sẽ hiển thị tại đây.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
