<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tao User va Don Hang Tan Phu</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .info { color: #2196f3; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .cyan { color: #00bcd4; font-weight: bold; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .config {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .config h3 {
            margin-top: 0;
            color: #667eea;
        }
        .config-item {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ T·∫°o User M·ªõi v√† 10 ƒê∆°n H√†ng T√¢n Ph√∫</h1>
        
        <div class="config">
            <h3>‚öôÔ∏è C·∫•u h√¨nh:</h3>
            <div class="config-item">üìß Email: <strong id="configEmail">ƒëang t·∫°o...</strong></div>
            <div class="config-item">üë§ Username: <strong id="configUsername">ƒëang t·∫°o...</strong></div>
            <div class="config-item">üîë Password: <strong>123456</strong></div>
            <div class="config-item">üè™ Chi nh√°nh: <strong>T√¢n Ph√∫ (ID: 2)</strong></div>
            <div class="config-item">üì¶ S·ªë ƒë∆°n: <strong>10 ƒë∆°n h√†ng</strong></div>
        </div>
        
        <button id="runBtn" onclick="runScript()">‚ñ∂Ô∏è CH·∫†Y SCRIPT</button>
        
        <div id="output"></div>
    </div>

    <script>
        const CONFIG = {
            baseUrl: 'http://localhost:8080',
            tanPhuBranchId: 2,
            numberOfOrders: 10,
            
            newUser: {
                username: `testuser_${Date.now()}`,
                email: `testuser_${Date.now()}@test.com`,
                password: "123456",
                fullName: "Nguyen Van Test",
                phone: "0909123456"
            },
            
            products: [
                { variantId: 1, quantity: 2 },
                { variantId: 2, quantity: 1 },
                { variantId: 3, quantity: 3 }
            ],
            
            shipping: {
                name: "Nguyen Van Test",
                phone: "0909123456",
                address: "123 Duong ABC, Phuong Tan Phu, Quan 7, TP.HCM"
            }
        };

        // Update config display
        document.getElementById('configEmail').textContent = CONFIG.newUser.email;
        document.getElementById('configUsername').textContent = CONFIG.newUser.username;

        const outputEl = document.getElementById('output');
        const runBtn = document.getElementById('runBtn');

        function log(message, type = 'info') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = message + '\n';
            outputEl.appendChild(span);
            outputEl.scrollTop = outputEl.scrollHeight;
        }

        function logPlain(message) {
            outputEl.appendChild(document.createTextNode(message + '\n'));
            outputEl.scrollTop = outputEl.scrollHeight;
        }

        async function registerUser(userInfo) {
            try {
                const registerPageResponse = await fetch(`${CONFIG.baseUrl}/Account/Register`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const registerPageHtml = await registerPageResponse.text();
                
                const tokenMatch = registerPageHtml.match(/name="__RequestVerificationToken"[^>]*value="([^"]+)"/);
                if (!tokenMatch) {
                    throw new Error('Khong tim thay antiforgery token');
                }
                const token = tokenMatch[1];
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                formData.append('Username', userInfo.username);
                formData.append('FullName', userInfo.fullName);
                formData.append('Email', userInfo.email);
                formData.append('PhoneNumber', userInfo.phone);
                formData.append('Password', userInfo.password);
                formData.append('ConfirmPassword', userInfo.password);
                formData.append('AgreeTerms', 'true');
                
                const response = await fetch(`${CONFIG.baseUrl}/Account/Register`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    redirect: 'manual'
                });
                
                if (response.status === 0 || response.type === 'opaqueredirect' || response.redirected) {
                    return { success: true, message: 'Dang ky thanh cong' };
                }
                
                const result = await response.text();
                if (result.includes('thanh cong') || result.includes('success')) {
                    return { success: true, message: 'Dang ky thanh cong' };
                }
                
                return { success: false, message: 'Dang ky that bai' };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        async function loginUser(email, password) {
            try {
                const loginPageResponse = await fetch(`${CONFIG.baseUrl}/Account/Login`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const loginPageHtml = await loginPageResponse.text();
                
                const tokenMatch = loginPageHtml.match(/name="__RequestVerificationToken"[^>]*value="([^"]+)"/);
                
                const formData = new FormData();
                if (tokenMatch) {
                    formData.append('__RequestVerificationToken', tokenMatch[1]);
                }
                formData.append('Email', email);
                formData.append('Password', password);
                formData.append('RememberMe', 'false');
                
                const response = await fetch(`${CONFIG.baseUrl}/Account/Login`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    redirect: 'manual'
                });
                
                if (response.status === 0 || response.type === 'opaqueredirect' || response.redirected || response.status === 302) {
                    return { success: true, message: 'Dang nhap thanh cong' };
                }
                
                return { success: false, message: 'Dang nhap that bai' };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        async function addToCart(variantId, quantity, branchId) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/cart/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ProductVariantId: variantId,
                        Quantity: quantity,
                        BranchId: branchId
                    }),
                    credentials: 'include'
                });
                const result = await response.json();
                return result.Success;
            } catch (error) {
                return false;
            }
        }

        async function createOrder(branchId, shipping, orderIndex) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        BranchId: branchId,
                        ShippingRecipientName: `${shipping.name} - Don #${orderIndex}`,
                        ShippingRecipientPhone: shipping.phone,
                        ShippingAddress: shipping.address,
                        PaymentMethodId: 1,
                        ShippingFee: 30000,
                        DiscountAmount: 0
                    }),
                    credentials: 'include'
                });
                return await response.json();
            } catch (error) {
                return { Success: false, Message: error.message };
            }
        }

        async function clearCart() {
            try {
                await fetch(`${CONFIG.baseUrl}/api/cart/clear`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {}
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function runScript() {
            runBtn.disabled = true;
            outputEl.innerHTML = '';
            
            log('========================================', 'cyan');
            log('  TAO USER MOI VA DAT HANG TAN PHU', 'cyan');
            log('========================================', 'cyan');
            logPlain('');
            
            // Step 1: Register
            log('[1] DANG KY USER MOI...', 'warning');
            logPlain(`    Email: ${CONFIG.newUser.email}`);
            logPlain(`    Username: ${CONFIG.newUser.username}`);
            
            const registerResult = await registerUser(CONFIG.newUser);
            if (!registerResult.success) {
                log(`    X LOI: ${registerResult.message}`, 'error');
                runBtn.disabled = false;
                return;
            }
            log('    THANH CONG!', 'success');
            await sleep(1000);
            
            // Step 2: Login
            logPlain('');
            log('[2] DANG NHAP VOI USER MOI...', 'warning');
            
            const loginResult = await loginUser(CONFIG.newUser.email, CONFIG.newUser.password);
            if (!loginResult.success) {
                log(`    X LOI: ${loginResult.message}`, 'error');
                runBtn.disabled = false;
                return;
            }
            log('    THANH CONG!', 'success');
            await sleep(1000);
            
            // Step 3: Create orders
            logPlain('');
            log(`[3] TAO ${CONFIG.numberOfOrders} DON HANG CHO TAN PHU...`, 'warning');
            logPlain('');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 1; i <= CONFIG.numberOfOrders; i++) {
                log(`--- Don hang #${i} ---`, 'cyan');
                
                await clearCart();
                await sleep(200);
                
                logPlain('  Them san pham vao gio...');
                let addSuccess = true;
                for (const product of CONFIG.products) {
                    const added = await addToCart(product.variantId, product.quantity, CONFIG.tanPhuBranchId);
                    if (!added) {
                        addSuccess = false;
                        break;
                    }
                    await sleep(100);
                }
                
                if (!addSuccess) {
                    log('  X Loi them san pham', 'error');
                    failCount++;
                    continue;
                }
                log('  OK', 'success');
                
                logPlain('  Tao don hang...');
                await sleep(200);
                
                const orderResult = await createOrder(CONFIG.tanPhuBranchId, CONFIG.shipping, i);
                
                if (orderResult.Success) {
                    log('  THANH CONG', 'success');
                    logPlain(`    Order Code: ${orderResult.Data.OrderCode}`);
                    logPlain(`    Order ID: ${orderResult.Data.Id}`);
                    logPlain(`    Total: ${orderResult.Data.TotalAmount.toLocaleString('vi-VN')} VND`);
                    successCount++;
                } else {
                    log(`  LOI: ${orderResult.Message}`, 'error');
                    failCount++;
                }
                
                logPlain('');
                await sleep(800);
            }
            
            // Summary
            log('========================================', 'cyan');
            log('  KET QUA', 'cyan');
            log('========================================', 'cyan');
            log(`User moi: ${CONFIG.newUser.email}`, 'info');
            log(`Password: ${CONFIG.newUser.password}`, 'info');
            logPlain('');
            log(`Thanh cong: ${successCount} don hang`, 'success');
            log(`That bai: ${failCount} don hang`, 'error');
            logPlain('');
            logPlain(`Chi nhanh: Tan Phu (ID: ${CONFIG.tanPhuBranchId})`);
            log('========================================', 'cyan');
            
            runBtn.disabled = false;
        }
    </script>
</body>
</html>
